#!/bin/sh
#
# Wrapper that only allows certbot certonly on the MASTER node.

set -eu

ROLE_FILE="/var/run/haproxy_role"

if [ ! -f "${ROLE_FILE}" ] || ! grep -qi "master" "${ROLE_FILE}" 2>/dev/null; then
    echo "[INFO] certbot-certonly: Node is not MASTER (role from ${ROLE_FILE}), skipping certbot certonly." >&2
    exit 0
fi

# Hard fallback: always agree to ToS (unless already present)
case " $* " in
  *" --agree-tos "*) : ;;
  *) set -- --agree-tos "$@" ;;
esac

exec /usr/bin/certbot certonly "$@"
